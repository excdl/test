<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  font-family:"Arial","Noto Sans TC",sans-serif;
  background:#f0f4f8;
  display:flex;
  justify-content:center;
  padding:20px;
  margin:0;
}
.card{
  background:#fff;
  width:95%;
  max-width:480px;
  border-radius:20px;
  padding:25px 20px;
  box-shadow:0 15px 30px rgba(0,0,0,0.15);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
}
#userInfo{font-size:26px;font-weight:bold;color:#2c3e50}
#dateTime{font-size:20px;color:#7f8c8d}
#statusInfo{
  font-size:20px;
  color:#fff;
  padding:8px 25px;
  border-radius:25px;
  background:#95a5a6;
}
.buttons-container{
  display:flex;
  gap:15px;
  width:100%;
}
button{
  flex:1;
  padding:15px 0;
  font-size:22px;
  font-weight:bold;
  border-radius:12px;
  border:none;
  cursor:pointer;
  color:#fff;
}
#btnStart{background:linear-gradient(135deg,#3498db,#2980b9)}
#btnEnd{background:linear-gradient(135deg,#2ecc71,#27ae60)}
button:disabled{opacity:0.5;cursor:not-allowed}
#todayRecords{
  width:100%;
  background:#fafafa;
  border-radius:14px;
  padding:15px;
  border:1px solid #ddd;
  font-size:18px;
}
#todayRecords span{
  display:block;
  margin-bottom:6px;
  padding-left:6px;
  border-left:3px solid #3498db;
}
</style>
</head>

<body>
<div class="card">
  <div id="userInfo">è¼‰å…¥ä¸­...</div>
  <div id="statusInfo">å®šä½ç¢ºèªä¸­â€¦</div>
  <div id="dateTime"></div>

  <div class="buttons-container">
    <button id="btnStart" disabled>ä¸Šç­</button>
    <button id="btnEnd" disabled>ä¸‹ç­</button>
  </div>

  <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„</div>
</div>

<script>
/* =======================
   åŸºæœ¬è¨­å®š
======================= */
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzfoXMyj9jmKnHv_H-1nDAUzUWqcgaUOiJzXwtQXDdPodvtOinpc84fw8ybRxHyEwMi/exec";
const LIFF_ID = "2008786085-L1CtKqqv";

let userId="", userName="";
let locationReady=false;
let pageReady=false;

const btnStart = document.getElementById("btnStart");
const btnEnd   = document.getElementById("btnEnd");
const userInfo = document.getElementById("userInfo");
const statusInfo = document.getElementById("statusInfo");
const dateTime = document.getElementById("dateTime");
const todayRecords = document.getElementById("todayRecords");

/* =======================
   å·¥å…·
======================= */
function todayStr(){
  const d=new Date();
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
}

function updateClock(){
  dateTime.textContent = new Date().toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateClock,1000);
updateClock();

/* =======================
   IP & GPSï¼ˆå³æ™‚ï¼‰
======================= */
async function getIP(){
  const c=sessionStorage.getItem("ip");
  if(c) return c;
  const r=await fetch("https://api.ipify.org?format=json");
  const d=await r.json();
  sessionStorage.setItem("ip",d.ip);
  return d.ip;
}

function getGPS(){
  return new Promise((res,rej)=>{
    navigator.geolocation.getCurrentPosition(
      p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),
      e=>rej(e),
      {enableHighAccuracy:false,timeout:8000}
    );
  });
}

/* =======================
   LIFF åˆå§‹åŒ–
======================= */
async function initUser(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  const p=await liff.getProfile();
  userId=p.userId;
  userName=p.displayName;
  userInfo.textContent=`${userName} æ‚¨å¥½`;
}

/* =======================
   å®šä½ç‹€æ…‹é¡¯ç¤ºï¼ˆåªé¡¯ç¤ºï¼‰
======================= */
async function updateStatus(){
  try{
    const [ip,gps]=await Promise.all([getIP(),getGPS()]);
    const r=await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const d=await r.json();

    if(d.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"){
      statusInfo.textContent="æœ‰æ•ˆæ‰“å¡å€";
      statusInfo.style.background="#2ecc71";
    }else{
      statusInfo.textContent=`ç„¡æ•ˆæ‰“å¡å€${d.distance?` (${d.distance}m)`:""}`;
      statusInfo.style.background="#e74c3c";
    }
    locationReady=true;
    btnStart.disabled=false;
    btnEnd.disabled=false;
  }catch{
    statusInfo.textContent="å®šä½å¤±æ•—";
  }
}

/* =======================
   ä»Šæ—¥ç´€éŒ„
======================= */
async function loadToday(){
  todayRecords.textContent="è¼‰å…¥ä¸­...";
  const r=await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${todayStr()}`);
  const d=await r.json();
  if(!d.length){
    todayRecords.textContent="ä»Šæ—¥ç„¡ç´€éŒ„";
    return;
  }
  todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>";
  d.forEach(x=>{
    let c=x.status==="ä¸‹ç­"?"#2ecc71":"#3498db";
    if(x.company.includes("éŒ¯èª¤")) c="#e67e22";
    todayRecords.innerHTML+=
      `<span style="border-left-color:${c}">${x.status}ï¼š${x.time}ï¼ˆ${x.company}ï¼‰</span>`;
  });
}

/* =======================
   æ‰“å¡ï¼ˆæ ¸å¿ƒï¼‰
======================= */
async function clock(status){
  if(!locationReady){
    Swal.fire({icon:"info",title:"å®šä½ä¸­ï¼Œè«‹ç¨å€™",timer:1500,showConfirmButton:false});
    return;
  }

  const btn = status==="ä¸Šç­"?btnStart:btnEnd;
  btn.disabled=true;

  try{
    const [ip,gps]=await Promise.all([getIP(),getGPS()]);
    const r=await fetch(API_ENDPOINT,{
      method:"POST",
      body:JSON.stringify({userId,userName,ip,gps,status})
    });
    const d=await r.json();

    if(d.error){
      Swal.fire({icon:"warning",title:d.message});
      return;
    }

    if(d.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"){
      Swal.fire({
        icon:"success",
        title:"ğŸ‰ æ‰“å¡æˆåŠŸ",
        html:`${d.date} ${d.time}`,
        timer:2000,
        showConfirmButton:false
      });
    }else{
      Swal.fire({
        icon:"warning",
        title:"âš  æ‰“å¡ç„¡æ•ˆ",
        html:"ç•°åœ°æ‰“å¡è«‹å¿½ç•¥",
        timer:2000,
        showConfirmButton:false
      });
    }

    loadToday();
    updateStatus();

  }catch{
    Swal.fire({icon:"error",title:"æ‰“å¡å¤±æ•—"});
  }finally{
    btn.disabled=false;
  }
}

btnStart.onclick=()=>clock("ä¸Šç­");
btnEnd.onclick=()=>clock("ä¸‹ç­");

/* =======================
   å•Ÿå‹•
======================= */
window.onload=async()=>{
  await initUser();
  pageReady=true;
  loadToday();
  updateStatus();
};
</script>
</body>
</html>





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































