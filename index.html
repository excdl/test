<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: "Arial","Noto Sans TC",sans-serif;
  background: #f0f4f8;
  display: flex;
  justify-content: center;
  padding: 20px;
  margin: 0;
}
.card {
  background: #fff;
  width: 95%;
  max-width: 480px;
  border-radius: 20px;
  padding: 25px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}
#userInfo {
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  color: #2c3e50;
}
#dateTime {
  font-size: 22px;
  color: #7f8c8d;
  text-align: center;
}
#statusInfo {
  font-size: 20px;
  color: white;
  padding: 8px 25px;
  border-radius: 25px;
  text-align: center;
  min-width: 180px;
}
.buttons-container {
  display: flex;
  gap: 15px;
  width: 100%;
}
.buttons-container button {
  flex: 1;
  padding: 15px 0;
  font-size: 22px;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: white;
  transition: all 0.2s;
}
#btnStart { background: linear-gradient(135deg, #3498db, #2980b9); }
#btnEnd { background: linear-gradient(135deg, #2ecc71, #27ae60); }

#todayRecords {
  width: 100%;
  background: #fafafa;
  border-radius: 14px;
  padding: 15px;
  border: 1px solid #ddd;
  font-size: 18px;
  text-align: left;
}
#todayRecords span {
  display: block;
  margin-bottom: 5px;
  padding-left: 5px;
  border-left: 3px solid #3498db;
}
</style>
</head>

<body>
<div class="card">
  <div id="userInfo">è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šä¸­...</div>
   <div id="statusInfo">æª¢æŸ¥ä¸­â€¦</div>
 <div id="dateTime">è¼‰å…¥ä¸­â€¦</div>
  <div class="buttons-container">
    <button id="btnStart">ä¸Šç­</button>
    <button id="btnEnd">ä¸‹ç­</button>
  </div>

  <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆé»æ“Šæ›´æ–°ï¼‰</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzmiYZPRcsliCLaCARTIhBNYAB4oRjB4rKUczOBn8QjKt71lxbylQ1t-w24obpR4dNI/exec";
let userId="", userName="";

// åˆå§‹åŒ–ä½¿ç”¨è€…
async function initUser(){
  await liff.init({liffId:"2008786085-L1CtKqqv"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} æ‚¨å¥½`;
}

// æ™‚é–“æ›´æ–°
function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent =
    now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

// å–å¾— IP
async function getIP(){
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP",data.ip);
    return data.ip;
  }catch{return "";}
}

// æ›´æ–°æ‰“å¡ç‹€æ…‹
async function updateStatus(){
  const ip = await getIP();
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    try{
      const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
      const data = await res.json();
      const statusEl = document.getElementById("statusInfo");
      if(data.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"){
        statusEl.style.background="#2ecc71";
        statusEl.textContent="æœ‰æ•ˆæ‰“å¡å€";
      } else {
        statusEl.style.background="#e74c3c";
        const distText = data.distance!==null ? ` (${data.distance} å…¬å°º)` : "";
        statusEl.textContent="ç„¡æ•ˆæ‰“å¡å€"+distText;
      }
    }catch(err){}
  });
}
setInterval(updateStatus,5000);
updateStatus();

// ä»Šæ—¥æ‰“å¡ç´€éŒ„
async function updateTodayRecords(){
  const today = new Date().toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");
  const container=document.getElementById("todayRecords");
  container.innerHTML="è¼‰å…¥ä¸­...";
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    if(!data.length){
      container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡";
      return;
    }
    container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>";
    data.forEach(r=>{
      container.innerHTML+=`<span>${r.status}ï¼š${r.time}ï¼ˆ${r.company}ï¼‰</span>`;
    });
  }catch{
    container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—";
  }
}

// âœ… æ‰“å¡åŠŸèƒ½ï¼ˆç«‹å³æ‰“å¡ + æŒ‰éˆ•é¡¯ç¤ºå€’æ•¸ï¼‰
async function clockInOut(status) {
  const btn = status === "ä¸Šç­" ? document.getElementById("btnStart") : document.getElementById("btnEnd");
  btn.disabled = true;
  const originalText = btn.textContent;

  // UI å€’æ•¸æç¤º
  let sec = 3;
  const timer = setInterval(() => {
    btn.textContent = `æ‰“å¡ä¸­â€¦ ${sec}s`;
    sec--;
    if (sec < 0) clearInterval(timer);
  }, 1000);

  const ip = await getIP();

  if (!navigator.geolocation) {
    clearInterval(timer);
    btn.textContent = originalText;
    btn.disabled = false;

    Swal.fire({
      icon: "error",
      title: "ğŸ˜¥ æ‰“å¡å¤±æ•—",
      html: "è«‹æŸ¥çœ‹ç´€éŒ„",
      showConfirmButton: false,
      timer: 2000,
      backdrop: "rgba(0,0,0,0.5)"
    });
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async pos => {
      const gps = { lat: pos.coords.latitude, lng: pos.coords.longitude };

      try {
        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ userId, userName, ip, gps, status })
        });
        const apiData = await res.json();

        // ===== ä¸‰æƒ…å¢ƒåˆ¤æ–· =====
        if (apiData.rangeStatus === "æœ‰æ•ˆæ‰“å¡å€") {
          // âœ… æˆåŠŸ
          Swal.fire({
            icon: "success",
            title: "ğŸ‰ æ‰“å¡æˆåŠŸï¼",
            html: `<strong>æ‰“å¡æ™‚é–“ï¼š</strong> ${apiData.date} ${apiData.time}`,
            showConfirmButton: false,
            timer: 2000,
            backdrop: "rgba(0,0,0,0.5)"
          });
        } else if (apiData.rangeStatus === "ç„¡æ•ˆæ‰“å¡å€") {
          // âš ï¸ ç•°åœ°æ‰“å¡
          Swal.fire({
            icon: "warning",
            title: `<span style="font-size:20px;color:#e67e22;">âš  æ‰“å¡ç„¡æ•ˆ</span>`,
            html: `<div style="font-size:16px;color:#3498db;font-weight:bold;margin-top:8px;">â— ç•°åœ°æ‰“å¡è«‹å¿½ç•¥ â—</div>`,
            showConfirmButton: false,
            timer: 2000,
            backdrop: "rgba(0,0,0,0.5)"
          });
        }

        updateTodayRecords();
        updateStatus();

      } catch {
        // âŒ æ‰“å¡å¤±æ•—
        Swal.fire({
          icon: "error",
          title: "ğŸ˜¥ æ‰“å¡å·²æ›´æ–°",
          html: "è«‹æŸ¥çœ‹ç´€éŒ„",
          showConfirmButton: false,
          timer: 2000,
          backdrop: "rgba(0,0,0,0.5)"
        });
      } finally {
        clearInterval(timer);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    },
    () => {
      clearInterval(timer);
      btn.textContent = originalText;
      btn.disabled = false;

      Swal.fire({
        icon: "error",
        title: "ğŸ˜¥ æ‰“å¡å¤±æ•—",
        html: "è«‹æŸ¥çœ‹ç´€éŒ„",
        showConfirmButton: false,
        timer: 2000,
        backdrop: "rgba(0,0,0,0.5)"
      });
    }
  );
}



document.getElementById("btnStart").onclick=()=>clockInOut("ä¸Šç­");
document.getElementById("btnEnd").onclick=()=>clockInOut("ä¸‹ç­");

window.onload=async()=>{
  await initUser();
  updateTodayRecords();
};
</script>
</body>
</html>




















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































