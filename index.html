<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/* ---------- BODY ---------- */
body {
  font-family: "Arial","Noto Sans TC",sans-serif;
  background: #f0f4f8;
  display: flex;
  justify-content: center;
  padding: 20px;
  margin: 0;
}

/* ---------- CARD ---------- */
.card {
  background: #fff;
  width: 95%;
  max-width: 480px;
  border-radius: 20px;
  padding: 25px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
  animation: cardFadeIn 0.5s ease forwards;
}
@keyframes cardFadeIn {
  from {opacity:0; transform: translateY(20px);}
  to {opacity:1; transform: translateY(0);}
}

/* ---------- USER INFO ---------- */
#userInfo {
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  color: #2c3e50;
}

#dateTime {
  font-size: 22px;
  color: #7f8c8d;
  text-align: center;
}

/* ---------- STATUS CARDS ---------- */
#statusContainer {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

#statusContainer div {
  padding: 12px 20px;
  border-radius: 14px;
  color: #fff;
  font-size: 18px;
  font-weight: 600;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  transition: all 0.3s;
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.5s forwards;
}

#statusContainer div:nth-child(1) { animation-delay: 0.2s; }
#statusContainer div:nth-child(2) { animation-delay: 0.4s; }

@keyframes fadeInUp {
  to {opacity:1; transform: translateY(0);}
}

/* 顏色漸層 */
#nearestCompany { background: linear-gradient(135deg, #e74c3c, #c0392b); }
#rangeStatus { background: linear-gradient(135deg, #3498db, #2980b9); }

/* ---------- CLOCK BUTTON ---------- */
#btnClock {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  border: none;
  font-size: 28px;
  font-weight: bold;
  color: #fff;
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  cursor: pointer;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  transition: 0.3s;
  position: relative;
  overflow: hidden;
}

#btnClock.off { background: linear-gradient(135deg, #3498db, #2980b9); }

#btnClock:active {
  transform: scale(0.95);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* 旋轉 spinner */
#btnClock .spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 35px;
  height: 35px;
  animation: spin 1s linear infinite;
  display: none;
}
@keyframes spin {
  0% {transform: translate(-50%,-50%) rotate(0deg);}
  100% {transform: translate(-50%,-50%) rotate(360deg);}
}

/* ---------- TODAY RECORDS ---------- */
#todayRecords {
  width: 100%;
  background: #fafafa;
  border-radius: 14px;
  padding: 15px;
  border: 1px solid #ddd;
  font-size: 18px;
  text-align: left;
  cursor: pointer;
  box-shadow: 0 5px 10px rgba(0,0,0,0.05);
  transition: 0.3s;
}
#todayRecords:hover { background: #f1f5f9; }
#todayRecords span {
  display: block;
  margin-bottom: 5px;
  padding-left: 5px;
  border-left: 3px solid #3498db;
}

/* ---------- ICONS & COLORS (選擇性) ---------- */
</style>
</head>
<body>
<div class="card">
  <div id="userInfo">載入使用者資訊中...</div>
  <div id="dateTime">載入中…</div>

  <div id="statusContainer">
    <div id="nearestCompany">不明連線</div>
    <div id="rangeStatus">可打卡範圍 (0 公尺)</div>
  </div>

  <button id="btnClock">
    打卡
    <div class="spinner"></div>
  </button>

  <div id="todayRecords" onclick="updateTodayRecords()">今日打卡紀錄（點擊更新）</div>
</div>

<script>
// ---------- INITIAL SETUP ----------
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwWINQPAXaU0-WJ-Fo7kXdB6TEzT_AiJKnftTiqIPnsg4mp3aojnVSqvzRQb7IchTAf/exec";
let userId="",userName="";

async function initUser(){
  await liff.init({liffId:"2008504718-nmXP0WRV"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} 您好`;
}

function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

// ---------- GET IP ----------
async function getIP(){
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP",data.ip);
    return data.ip;
  }catch{return "";}
}

// ---------- UPDATE STATUS ----------
async function updateStatus(){
  const ip = await getIP();
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    try{
      const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
      const data = await res.json();
      document.getElementById("nearestCompany").textContent = data.ipMatched ? data.nearestCompany.name : "不明連線";
      const distText = data.distance!==null ? ` (${data.distance.toFixed(0)} 公尺)` : "";
      document.getElementById("rangeStatus").textContent = `${data.rangeStatus}${!data.ipMatched ? distText : ""}`;
    }catch(err){
      document.getElementById("nearestCompany").textContent = "錯誤";
      document.getElementById("rangeStatus").textContent = "-";
    }
  });
}
setInterval(updateStatus,5000);
updateStatus();

// ---------- TODAY RECORDS ----------
async function updateTodayRecords(){
  const today = new Date().toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");
  const container=document.getElementById("todayRecords");
  container.innerHTML="載入中...";
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    if(!data.length){container.innerHTML="今日打卡紀錄：無"; return;}
    container.innerHTML = "今日打卡紀錄：<br>";
    data.forEach(r=>{
      container.innerHTML += `<span>• ${r.status} ${r.time}（${r.company}）</span>`;
    });
  }catch{
    container.innerHTML="今日打卡紀錄：讀取失敗";
  }
}

// ---------- CLOCK BUTTON ----------
document.getElementById("btnClock").onclick = async ()=>{
  const btn = document.getElementById("btnClock");
  const spinner = btn.querySelector(".spinner");
  btn.disabled = true;
  spinner.style.display="block";
  btn.textContent="打卡中…";
  spinner.style.display="block";

  const ip = await getIP();
  if(!navigator.geolocation){ Swal.fire("⚠ 無法取得位置"); return; }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const res = await fetch(API_ENDPOINT,{
      method:"POST",
      body:JSON.stringify({userId,userName,ip,gps})
    });
    const data = await res.json();
    Swal.fire({icon:"success",title:data.message,html:`${data.date} ${data.time}`,timer:2000,showConfirmButton:false});

    btn.textContent="打卡";
    spinner.style.display="none";
    btn.disabled = false;
    updateTodayRecords();
  }, err=>{Swal.fire("⚠ 無法取得GPS位置"); btn.textContent="打卡"; spinner.style.display="none"; btn.disabled=false;});
}

// ---------- ONLOAD ----------
window.onload = async ()=>{
  await initUser();
  updateTodayRecords();
};
</script>
</body>
</html>



































































































































































































































































