<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºæ…§æ‰“å¡ç³»çµ±</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  font-family:"Microsoft JhengHei",Arial;
  background:#eef2f7;
  margin:0;
  padding:20px;
  display:flex;
  justify-content:center;
}
.card{
  width:100%;
  max-width:480px;
  background:#fff;
  border-radius:20px;
  padding:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}
.title{font-size:26px;font-weight:bold;text-align:center;}
.info{margin:10px 0;font-size:18px;}
.badge{display:inline-block;padding:5px 14px;border-radius:20px;font-weight:bold}
.ok{background:#e8f7ef;color:#1e8449}
.err{background:#fdecea;color:#922b21}
.time{font-size:20px;text-align:center;margin:10px 0}
.circle{
  width:140px;height:140px;border-radius:50%;
  border:none;font-size:26px;color:#fff;
  cursor:pointer;display:block;margin:20px auto;
  box-shadow:0 6px 15px rgba(0,0,0,.3)
}
.on{background:#3498db}
.off{background:#2ecc71}
.records{
  border:1px solid #ddd;border-radius:12px;
  padding:10px;font-size:16px;min-height:80px;
  cursor:pointer;background:#fafafa
}
</style>
</head>
<body>

<div class="card">
  <div class="title">æ™ºæ…§æ‰“å¡ç³»çµ±</div>

  <div class="info">ğŸ‘¤ ä½¿ç”¨è€…ï¼š<b id="userName">è¼‰å…¥ä¸­...</b></div>
  <div class="info">ğŸ¢ é€£ç·šæ“šé»ï¼š<span id="company" class="badge err">è¼‰å…¥ä¸­</span></div>
  <div class="info">ğŸ“ æ‰“å¡ç¯„åœï¼š<span id="range" class="badge err">åˆ¤æ–·ä¸­</span></div>

  <div class="time" id="nowTime"></div>

  <button id="clockBtn" class="circle on">ä¸Šç­</button>

  <div class="records" id="records">ğŸ“„ ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆé»æ“Šåˆ·æ–°ï¼‰</div>
</div>

<script>
/* ================== åŸºæœ¬è¨­å®š ================== */
const LIFF_ID = "YOUR_LIFF_ID";
const API_URL = "https://script.google.com/macros/s/AKfycbzSxc1UyM75jxbVe1lg1dNKkxvQqrP92xmDz47lLYXDXGoBx3aQ9s_Rejy0I6UPStup/exec";

/* ================== State ================== */
let state = {
  userId:"",
  userName:"",
  isClockIn:true
};

/* ================== æ™‚é–“ ================== */
function updateTime(){
  document.getElementById("nowTime").innerText =
    new Date().toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateTime,1000);
updateTime();

/* ================== IP ================== */
async function getIP(){
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    return (await r.json()).ip;
  }catch{return "";}
}

/* ================== LIFF ================== */
async function initLIFF(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  state.userId = p.userId;
  state.userName = p.displayName;
  document.getElementById("userName").innerText = state.userName;
}

/* ================== æ‰“å¡ ================== */
async function clock(){
  const btn = document.getElementById("clockBtn");
  btn.disabled = true;
  btn.innerText = "æ‰“å¡ä¸­...";

  const ip = await getIP();

  navigator.geolocation.getCurrentPosition(async pos=>{
    const res = await fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        userId:state.userId,
        userName:state.userName,
        status: state.isClockIn?"ä¸Šç­":"ä¸‹ç­",
        ip,
        gps:{lat:pos.coords.latitude,lng:pos.coords.longitude}
      })
    });
    const data = await res.json();

    updateCompanyUI(data);
    Swal.fire(data.message);

    state.isClockIn = !state.isClockIn;
    btn.innerText = state.isClockIn?"ä¸Šç­":"ä¸‹ç­";
    btn.className = "circle " + (state.isClockIn?"on":"off");
    btn.disabled = false;

    loadToday();
  },()=>{
    Swal.fire("ç„¡æ³•å–å¾— GPS");
    btn.disabled = false;
  });
}

/* ================== UI æ›´æ–° ================== */
function updateCompanyUI(data){
  const c = document.getElementById("company");
  const r = document.getElementById("range");

  c.innerText = data.nearestCompany || "æœªçŸ¥é€£ç·š";
  c.className = "badge " + (data.nearestCompany?"ok":"err");

  r.innerText = data.rangeStatus;
  r.className = "badge " + (data.rangeStatus==="æ­£å¸¸"?"ok":"err");
}

/* ================== ä»Šæ—¥ç´€éŒ„ ================== */
async function loadToday(){
  const today = new Date().toISOString().slice(0,10);
  const res = await fetch(`${API_URL}?action=today&userId=${state.userId}&date=${today}`);
  const data = await res.json();

  const box = document.getElementById("records");
  if(!data.length){
    box.innerHTML = "ğŸ“„ ä»Šæ—¥ç„¡æ‰“å¡ç´€éŒ„";
    return;
  }
  box.innerHTML = "ğŸ“„ ä»Šæ—¥æ‰“å¡ç´€éŒ„<br>" +
    data.map(r=>`${r.time} ${r.status}`).join("<br>");
}

/* ================== å•Ÿå‹• ================== */
document.getElementById("clockBtn").onclick = clock;
document.getElementById("records").onclick = loadToday;

window.onload = async ()=>{
  await initLIFF();
  loadToday();
};
</script>
</body>
</html>











































































































































































































































































