<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f7f7f7; display:flex; justify-content:center; padding:25px; margin:0; }
.card { background:white; width:95%; max-width:480px; box-shadow:0 8px 25px rgba(0,0,0,0.12); border-radius:18px; padding:25px 20px; display:flex; flex-direction:column; align-items:center; gap:20px; }
#userInfo { font-size:24px; font-weight:bold; }
#statusInfo { font-size:20px; padding:6px 18px; border-radius:30px; display:inline-block; font-weight:bold; }
#dateTime { font-size:18px; }
#clockBtn { width:120px; height:120px; border-radius:50%; font-size:22px; font-weight:bold; border:none; cursor:pointer; transition:0.3s; }
#todayRecords { width:100%; background:#fafafa; border-radius:12px; padding:15px; border:1px solid #ddd; font-size:16px; cursor:pointer; }
</style>
</head>
<body>
<div class="card">
  <div id="userInfo">正在獲取使用者資訊...</div>
  <div id="statusInfo">載入中...</div>
  <div id="dateTime">載入中...</div>
  <button id="clockBtn">上班</button>
  <div id="todayRecords">今日打卡紀錄：點擊刷新</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyE-LTSMb0NcERkHvy48G337vQH3IxsuajHvJLnkf8x_x-upXbwETMluTOxcAaz3w/exec"; // 後端 doPost 網址

let status = "上班";
let userId = "", userName = "";

// 更新時間
function updateDateTime() {
  const now = new Date();
  document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

// LIFF 初始化
async function initUser(){
  await liff.init({ liffId: "你的 LIFF ID" });
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} 您好`;
  document.getElementById("statusInfo").textContent = "正在準備打卡...";
}

// 獲取 IP
async function getIP(){
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  }catch{ return ""; }
}

// 打卡
async function clockInOut(){
  document.getElementById("clockBtn").disabled = true;
  document.getElementById("statusInfo").textContent = "打卡中...";

  let ip = await getIP();
  let gps = null;
  try{
    gps = await new Promise((resolve,reject)=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        resolve({lat:pos.coords.latitude,lng:pos.coords.longitude});
      },err=>resolve(null),{enableHighAccuracy:true,timeout:5000});
    });
  }catch{ gps=null; }

  // 發送 API
  let resData = {userId,userName,status,ip,gps};
  try{
    const res = await fetch(API_ENDPOINT,{
      method:"POST",
      body: JSON.stringify(resData)
    });
    const result = await res.json();
    Swal.fire({icon:"success",title:result.message,html:`打卡時間：${result.date} ${result.time}`,timer:2000,showConfirmButton:false});
    updateTodayRecords();
  }catch(err){
    Swal.fire({icon:"error",title:"打卡失敗",html:err,message,timer:2000,showConfirmButton:false});
  }

  // 切換按鈕
  status = status=="上班"?"下班":"上班";
  updateClockBtn();
  document.getElementById("clockBtn").disabled = false;
}

// 更新按鈕文字與顏色
function updateClockBtn(){
  const btn = document.getElementById("clockBtn");
  btn.textContent = status;
  btn.style.background = status=="上班"?"linear-gradient(145deg,#3498db,#2980b9)":"linear-gradient(145deg,#2ecc71,#27ae60)";
  btn.style.color="white";
}

// 今日打卡紀錄
async function updateTodayRecords(){
  const today = new Date().toISOString().slice(0,10);
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    const container = document.getElementById("todayRecords");
    if(!data.length){ container.innerHTML="今日打卡紀錄：無"; return; }
    container.innerHTML="今日打卡紀錄：<br>"+data.map(r=>{
      let color = (r.distance && parseFloat(r.distance)>r.allow)?'red':'green';
      return `<span style="color:${color}">${r.status} ${r.time} ${r.distance?r.distance+"公尺":""} ${r.nearestCompany||""}</span>`;
    }).join("<br>");
  }catch{ document.getElementById("todayRecords").textContent="今日打卡紀錄：讀取失敗"; }
}

document.getElementById("clockBtn").onclick = clockInOut;
document.getElementById("todayRecords").onclick = updateTodayRecords;

window.onload = async ()=>{
  await initUser();
  updateClockBtn();
  updateTodayRecords();
};
</script>
</body>
</html>





































































































































