<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: "Arial","Noto Sans TC",sans-serif;
  background: #f0f4f8;
  display: flex;
  justify-content: center;
  padding: 20px;
  margin: 0;
}
.card {
  background: #fff;
  width: 95%;
  max-width: 480px;
  border-radius: 20px;
  padding: 25px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}
#userInfo {
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  color: #2c3e50;
}
#dateTime {
  font-size: 22px;
  color: #7f8c8d;
  text-align: center;
}
#statusInfo {
  font-size: 20px;
  color: white;
  padding: 8px 25px;
  border-radius: 25px;
  text-align: center;
  min-width: 180px;
}
.buttons-container {
  display: flex;
  gap: 15px;
  width: 100%;
}
.buttons-container button {
  flex: 1;
  padding: 15px 0;
  font-size: 22px;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: white;
  transition: all 0.2s;
}
#btnStart { background: linear-gradient(135deg, #3498db, #2980b9); }
#btnEnd { background: linear-gradient(135deg, #2ecc71, #27ae60); }

#todayRecords {
  width: 100%;
  background: #fafafa;
  border-radius: 14px;
  padding: 15px;
  border: 1px solid #ddd;
  font-size: 18px;
  text-align: left;
}
#todayRecords span {
  display: block;
  margin-bottom: 5px;
  padding-left: 5px;
  border-left: 3px solid #3498db;
}
</style>
</head>

<body>
<div class="card">
  <div id="userInfo">載入使用者資訊中...</div>
   <div id="statusInfo">檢查中…</div>
 <div id="dateTime">載入中…</div>
  <div class="buttons-container">
    <button id="btnStart">上班</button>
    <button id="btnEnd">下班</button>
  </div>

  <div id="todayRecords">今日打卡紀錄（點擊更新）</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbz3DOS3jjk8P_jakZ2fPB2B8I9VkEkSxM9I7tC8imxsOE320aOjmIJd9LibAUnrlaM/exec";
let userId="", userName="";

// 初始化使用者
async function initUser(){
  await liff.init({liffId:"2008786085-L1CtKqqv"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} 您好`;
}

// 時間更新
function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent =
    now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

// 取得 IP
async function getIP(){
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP",data.ip);
    return data.ip;
  }catch{return "";}
}

// 更新打卡狀態
async function updateStatus(){
  const ip = await getIP();
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    try{
      const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
      const data = await res.json();
      const statusEl = document.getElementById("statusInfo");
      if(data.rangeStatus==="有效打卡區"){
        statusEl.style.background="#2ecc71";
        statusEl.textContent="有效打卡區";
      } else {
        statusEl.style.background="#e74c3c";
        const distText = data.distance!==null ? ` (${data.distance} 公尺)` : "";
        statusEl.textContent="無效打卡區"+distText;
      }
    }catch(err){}
  });
}
setInterval(updateStatus,5000);
updateStatus();

// 今日打卡紀錄
async function updateTodayRecords(){
  const today = new Date().toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");
  const container=document.getElementById("todayRecords");
  container.innerHTML="載入中...";
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    if(!data.length){
      container.innerHTML="今日打卡紀錄：無";
      return;
    }
    container.innerHTML="今日打卡紀錄：<br>";
    data.forEach(r=>{
      container.innerHTML+=`<span>${r.status}：${r.time}（${r.company}）</span>`;
    });
  }catch{
    container.innerHTML="今日打卡紀錄：讀取失敗";
  }
}

// ✅ 打卡功能（加入 3 秒倒數）
async function clockInOut(status){
  const btn = status==="上班" ? document.getElementById("btnStart") : document.getElementById("btnEnd");
  btn.disabled = true;
  const originalText = btn.textContent;

  let sec = 3;
  btn.textContent = `打卡中… ${sec}s`;
  const timer = setInterval(()=>{
    sec--;
    if(sec>0) btn.textContent = `打卡中… ${sec}s`;
  },1000);

  const ip = await getIP();
  if(!navigator.geolocation){
    clearInterval(timer);
    btn.textContent = originalText;
    btn.disabled = false;
    Swal.fire("⚠ 無法取得位置");
    return;
  }

  setTimeout(()=>{
    navigator.geolocation.getCurrentPosition(async pos=>{
      const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
      try{
        const res = await fetch(API_ENDPOINT,{
          method:"POST",
          body: JSON.stringify({userId,userName,ip,gps,status})
        });
        const data = await res.json();
        Swal.fire({
          icon:"success",
          title:data.message,
          html:`${data.date} ${data.time}`,
          timer:2000,
          showConfirmButton:false
        });
        updateTodayRecords();
        updateStatus();
      }catch{
        Swal.fire("⚠ 打卡失敗");
      }finally{
        clearInterval(timer);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    },()=>{
      clearInterval(timer);
      btn.textContent = originalText;
      btn.disabled = false;
      Swal.fire("⚠ 無法取得GPS位置");
    });
  },3000);
}

document.getElementById("btnStart").onclick=()=>clockInOut("上班");
document.getElementById("btnEnd").onclick=()=>clockInOut("下班");

window.onload=async()=>{
  await initUser();
  updateTodayRecords();
};
</script>
</body>
</html>





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































