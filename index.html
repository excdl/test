<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Êô∫ËÉΩÊâìÂç°Á≥ªÁµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {font-family:"Arial","Noto Sans TC",sans-serif;background:#f0f4f8;display:flex;justify-content:center;padding:20px;margin:0;}
.card {background:#fff;width:95%;max-width:480px;border-radius:20px;padding:25px 20px;display:flex;flex-direction:column;align-items:center;gap:20px;box-shadow:0 15px 30px rgba(0,0,0,0.15);}
#userInfo {font-size:28px;font-weight:bold;text-align:center;color:#2c3e50;}
#dateTime {font-size:22px;color:#7f8c8d;text-align:center;}
#statusInfo {font-size:20px;color:white;padding:8px 25px;border-radius:25px;text-align:center;min-width:180px;}
.buttons-container {display:flex;gap:15px;width:100%;}
.buttons-container button {flex:1;padding:15px 0;font-size:22px;font-weight:bold;border-radius:12px;border:none;cursor:pointer;color:white;transition:all 0.2s;}
#btnStart {background: linear-gradient(135deg, #3498db, #2980b9);}
#btnEnd {background: linear-gradient(135deg, #2ecc71, #27ae60);}
button:disabled {opacity:0.5;cursor:not-allowed;}
#todayRecords {width:100%;background:#fafafa;border-radius:14px;padding:15px;border:1px solid #ddd;font-size:18px;text-align:left;}
#todayRecords span {display:block;margin-bottom:5px;padding-left:5px;border-left:3px solid #3498db;}
/* ‰∏ªÁÆ°ÂØ©ÊâπÊåâÈàï */
#btnApprove {
    margin-top:10px;
    padding:12px 20px;
    font-size:18px;
    font-weight:bold;
    border-radius:10px;
    background:linear-gradient(145deg,#8e44ad,#663399);
    color:white;
    display:none;
    width:100%;
    cursor:pointer;
    border:none;
}
#btnApprove:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

</style>
</head>
<body>
<div class="card">
  <div id="userInfo">ËºâÂÖ•‰ΩøÁî®ËÄÖË≥áË®ä‰∏≠...</div>
  <div id="statusInfo">ÂÆö‰ΩçÁ¢∫Ë™ç‰∏≠‚Ä¶</div>
  <div id="dateTime">ËºâÂÖ•‰∏≠‚Ä¶</div>
  <div class="buttons-container">
    <button id="btnStart" disabled>‰∏äÁè≠</button>
    <button id="btnEnd" disabled>‰∏ãÁè≠</button>
  </div>
  <div id="todayRecords">‰ªäÊó•ÊâìÂç°Á¥ÄÈåÑÔºàÈªûÊìäÊõ¥Êñ∞Ôºâ</div>
  <button id="btnApprove">Êü•Áúã|Á∞ΩÊ†∏</button>
</div>
 
<script>
const API_ENDPOINT="https://script.google.com/macros/s/AKfycbwSkLjxiKyGkIswLZSXTPn5TE2xEVIAqfd9uUC2O602ETwTv5szasAz5DbvhwV2hRtm/exec";
let userId="", userName="", dataReady=false;
let statusLoaded=false;
let MANAGERS = [];

const btnStart=document.getElementById("btnStart");
const btnEnd=document.getElementById("btnEnd");
const userInfo=document.getElementById("userInfo");
const statusInfo=document.getElementById("statusInfo");
const dateTime=document.getElementById("dateTime");
const todayRecords=document.getElementById("todayRecords");

async function loadManagers(){
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getManagers`);
    MANAGERS = await res.json();
    console.log("‰∏ªÁÆ°Ê∏ÖÂñÆ =", MANAGERS);
  }catch(err){
    console.error("ËÆÄÂèñ‰∏ªÁÆ°Â§±Êïó", err);
    MANAGERS = [];
  }
}
    
/* ===== Êó•ÊúüÂ≠ó‰∏≤ yyyy/MM/dd ===== */
function getTodayString(){
  const d=new Date();
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
}

/* ===== ÊåâÈàïÈéñÂÆö ===== */
function setButtonsLock(lock){
  btnStart.disabled=lock;
  btnEnd.disabled=lock;
}

/* ===== ÊôÇÈñìÈ°ØÁ§∫ ===== */
function updateDateTime(){
  const now=new Date();
  dateTime.textContent=now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

/* ===== Âø´Âèñ IP Ëàá GPS ===== */
let lastGPS = null, lastGPSAt = 0;
let lastIP = null;

async function getCachedIP() {
  if (lastIP) return lastIP;
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    lastIP = data.ip;
    return lastIP;
  } catch {
    return "";
  }
}

function getCachedGPS(maxAge = 60000) { // Âø´Âèñ 1 ÂàÜÈêò
  return new Promise((resolve, reject) => {
    const now = Date.now();
    if (lastGPS && now - lastGPSAt < maxAge) {
      resolve(lastGPS);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        lastGPS = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        lastGPSAt = Date.now();
        resolve(lastGPS);
      },
      err => reject(err),
      { enableHighAccuracy: false, timeout: 3000 } // timeout Êîπ 3 Áßí
    );
  });
}

/* ===== LIFF ‰ΩøÁî®ËÄÖÂàùÂßãÂåñ ===== */
async function initUser(){
  await liff.init({ liffId: "2008786085-L1CtKqqv" });

  if (!liff.isLoggedIn()) {
    await liff.login();
  }

  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;

  userInfo.textContent = `${userName} ÊÇ®Â•Ω`;

  // ‚≠ê ÂÖàËÆÄ‰∏ªÁÆ°Ê∏ÖÂñÆ
  await loadManagers();

  console.log("LIFF userId =", userId);
  console.log("ÊòØÂê¶‰∏ªÁÆ° =", MANAGERS.includes(userId));

  if (MANAGERS.includes(userId)) {
    document.getElementById("btnApprove").style.display = "block";
  }
}


/* ===== Êõ¥Êñ∞ÊâìÂç°ÂçÄÁãÄÊÖã ===== */
async function updateStatus() {
  // ÂÖàÁ´ãÂç≥È°ØÁ§∫ UIÔºå‰∏çÁ≠âÂæÖ GPS
  statusInfo.textContent = "ÂÆö‰ΩçËºâÂÖ•‰∏≠‚Ä¶";
  statusInfo.style.background = "#95a5a6";

  try {
    const [ip, gps] = await Promise.all([getCachedIP(), getCachedGPS()]);

    const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const data = await res.json();

    if (data.rangeStatus === "ÊúâÊïàÊâìÂç°ÂçÄ") {
      statusInfo.style.background = "#2ecc71";
      statusInfo.textContent = "ÊúâÊïàÊâìÂç°ÂçÄ";
    } else {
      statusInfo.style.background = "#e74c3c";
      const distText = data.distance !== null ? ` (${data.distance} ÂÖ¨Â∞∫)` : "";
      statusInfo.textContent = "ÁÑ°ÊïàÊâìÂç°ÂçÄ" + distText;
    }

    statusLoaded = true;
  } catch(err) {
    // Â§±ÊïóÊôÇ‰øùÁïôÁÅ∞Ëâ≤ÊèêÁ§∫
    statusInfo.textContent = "ÂÆö‰ΩçÁ¢∫Ë™ç‰∏≠‚Ä¶";
    statusInfo.style.background = "#95a5a6";
    console.warn("Êõ¥Êñ∞ÁãÄÊÖãÂ§±ÊïóÔºö", err);
  }
}


/* ===== Êõ¥Êñ∞‰ªäÊó•ÊâìÂç°Á¥ÄÈåÑ ===== */
async function updateTodayRecords(){
  todayRecords.innerHTML="ËºâÂÖ•‰∏≠...";
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${getTodayString()}`);
    const data = await res.json();

    if(!data.length){
      todayRecords.innerHTML="‰ªäÊó•ÊâìÂç°Á¥ÄÈåÑÔºöÁÑ°";
      return;
    }

    todayRecords.innerHTML="‰ªäÊó•ÊâìÂç°Á¥ÄÈåÑÔºö<br>";

    data.forEach(r=>{
      let color="#3498db"; // ‰∏äÁè≠Ëóç
      if(r.status==="‰∏ãÁè≠") color="#2ecc71"; // ‰∏ãÁè≠Á∂†
      if(r.company.includes("ÈåØË™§")) color="#e67e22"; // Áï∞Â∏∏Ê©ò
      todayRecords.innerHTML+=`<span style="border-left-color:${color}">${r.status}Ôºö${r.time}Ôºà${r.company}Ôºâ</span>`;
    });
  }catch{
    todayRecords.innerHTML="‰ªäÊó•ÊâìÂç°Á¥ÄÈåÑÔºöËÆÄÂèñÂ§±Êïó";
  }
}

/* ===== ÊâìÂç°ÂæåÁôºÈÄÅ Flex Message Áµ¶Ëá™Â∑± ===== */
async function sendSelfMessage(record){
  if(!liff.isInClient()) return;

  let headerColor = "#3498db"; // ‰∏äÁè≠Ëóç
  if(record.status === "‰∏ãÁè≠") headerColor = "#2ecc71"; // ‰∏ãÁè≠Á∂†
  if(record.rangeStatus !== "ÊúâÊïàÊâìÂç°ÂçÄ") headerColor = "#e67e22"; // Áï∞Â∏∏Ê©ò

  let reasonText = record.rangeStatus !== "ÊúâÊïàÊâìÂç°ÂçÄ" ? "Áï∞Â∏∏ÂéüÂõ†ÔºöË∂ÖÂá∫ÊâìÂç°ÂçÄ" : "";

  try{
    await liff.sendMessages([{
      type:'flex',
      altText:'ÊâìÂç°ÈÄöÁü•',
      contents:{
        type:"bubble",
        header:{
          type:"box",
          layout:"vertical",
          contents:[{
            type:"text",
            text:`${record.userName} Â∑≤ÊâìÂç°`,
            weight:"bold",
            size:"lg",
            color:"#ffffff"
          }],
          backgroundColor: headerColor,
          paddingAll:"12px"
        },
        body:{
          type:"box",
          layout:"vertical",
          spacing:"md",
          contents:[
            {type:"text", text:`ÁãÄÊÖãÔºö${record.status}`, size:"md"},
            {type:"text", text:`ÊôÇÈñìÔºö${record.date} ${record.time}`, size:"md"},
            {type:"text", text:`‰ΩçÁΩÆÔºö${record.company}`, size:"md"},
            ...(reasonText ? [{type:"text", text: reasonText, size:"md", color:"#e67e22"}] : [])
          ]
        }
      }
    }]);
  }catch(err){
    console.error("Ë®äÊÅØÂÇ≥ÈÄÅÂ§±Êïó:", err);
  }
}

/* ===== ÊâìÂç°ÂäüËÉΩ ===== */
async function clockInOut(status){
  if(!dataReady || !statusLoaded){
    Swal.fire({icon:"info",title:"Ë≥áÊñôËÆÄÂèñ‰∏≠ÊàñÂÆö‰Ωç‰∏≠",timer:1500,showConfirmButton:false});
    return;
  }

  const btn = status==="‰∏äÁè≠"?btnStart:btnEnd;
  btn.disabled = true;
  const originalText = btn.textContent;

  let sec = 3;
  const timer = setInterval(()=>{
    btn.textContent = `ÊâìÂç°‰∏≠‚Ä¶ ${sec}s`;
    sec--;
    if(sec<0) clearInterval(timer);
  },1000);

  try{
    const ip = await getIP();
    const gps = await getCachedGPS();

    const res = await fetch(API_ENDPOINT, {
      method:"POST",
      body: JSON.stringify({userId,userName,ip,gps,status})
    });
    const data = await res.json();

    // Âè™ÊúâÁúüÊ≠£Êõ¥Êñ∞ÊàñÊñ∞Â¢ûÊâçÁôºË®äÊÅØ
    const actuallyUpdated = data.message && (data.message.includes("Â∑≤Êõ¥Êñ∞") || data.message.includes("ÊàêÂäü"));

    if(actuallyUpdated){
      const record = {
        userName: userName,
        status: data.status,
        date: data.date,
        time: data.time,
        company: data.company || "Êú™Áü•",
        rangeStatus: data.rangeStatus
      };

      if(data.rangeStatus === "ÊúâÊïàÊâìÂç°ÂçÄ"){
        Swal.fire({
          icon:"success",
          title:"üéâ ÊâìÂç°ÊàêÂäüÔºÅ",
          html:`<strong>ÊâìÂç°ÊôÇÈñìÔºö</strong> ${data.date} ${data.time}`,
          showConfirmButton:false,
          timer:2000,
          backdrop:"rgba(0,0,0,0.5)"
        });
      } else {
        Swal.fire({
          icon:"warning",
          title:`<span style="font-size:20px;color:#e67e22;">‚ö† ÊâìÂç°ÁÑ°Êïà</span>`,
          html:`<div style="font-size:16px;color:#3498db;font-weight:bold;margin-top:8px;">‚óé Áï∞Âú∞ÊâìÂç°Ë´ãÂøΩÁï• ‚óé</div>`,
          showConfirmButton:false,
          timer:2000,
          backdrop:"rgba(0,0,0,0.5)"
        });
      }

      sendSelfMessage(record);
      updateTodayRecords();
      updateStatus();
    }
    // ‚ùå Êú™Êõ¥Êñ∞‰∏çË∑≥ÊèêÁ§∫„ÄÅ‰∏çÁôºË®äÊÅØ
  }catch(err){
    console.error(err);
    Swal.fire({
      icon:"error",
      title:"üò• ÊâìÂç°Â§±Êïó",
      html:"Ë´ãÊü•ÁúãÁ¥ÄÈåÑ",
      showConfirmButton:false,
      timer:2000,
      backdrop:"rgba(0,0,0,0.5)"
    });
  } finally {
    clearInterval(timer);
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

btnStart.onclick = () => clockInOut("‰∏äÁè≠");
btnEnd.onclick = () => clockInOut("‰∏ãÁè≠");
document.getElementById("btnApprove").onclick = () => {
    window.location.href = "https://script.google.com/macros/s/AKfycbwWOaYQXY634RpY38RzJlPYxIrErb0Yl6mAffPPYd_XlhDFcKHyvQwZEoMtmjskO7iQEw/exec";
};
/* ===== È†ÅÈù¢ËºâÂÖ• ===== */
window.onload = async () => {
  // È†ÅÈù¢‰∏ÄÈñãÂïüÂ∞±ÂÖàÈ°ØÁ§∫ÊñáÂ≠ó
  statusInfo.textContent = "ÂÆö‰ΩçËºâÂÖ•‰∏≠‚Ä¶";
  statusInfo.style.background = "#95a5a6";

  setButtonsLock(true);
  await initUser();

  // ÁßíÂëàÁèæ UI
  updateTodayRecords();
  setButtonsLock(false);
  dataReady = true;

  // ÂæåÂè∞ÊÖ¢ÊÖ¢Êõ¥Êñ∞ÂÆö‰ΩçËàáÁãÄÊÖã
  updateStatus();
  setInterval(updateStatus, 15000); // ÊØè 15 ÁßíÊõ¥Êñ∞
};
</script>
</body>
</html>















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































