<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {
  font-family: "Arial","Noto Sans TC",sans-serif;
  background: #f0f4f8;
  display: flex;
  justify-content: center;
  padding: 20px;
  margin: 0;
}
.card {
  background: #fff;
  width: 95%;
  max-width: 480px;
  border-radius: 20px;
  padding: 25px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}
#userInfo {
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  color: #2c3e50;
}
#dateTime {
  font-size: 22px;
  color: #7f8c8d;
  text-align: center;
}
#statusInfo {
  font-size: 20px;
  color: white;
  padding: 8px 25px;
  border-radius: 25px;
  text-align: center;
  min-width: 180px;
}
.buttons-container {
  display: flex;
  gap: 15px;
  width: 100%;
}
.buttons-container button {
  flex: 1;
  padding: 15px 0;
  font-size: 22px;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  color: white;
  transition: all 0.2s;
}
#btnStart { background: linear-gradient(135deg, #3498db, #2980b9); }
#btnEnd { background: linear-gradient(135deg, #2ecc71, #27ae60); }

#todayRecords {
  width: 100%;
  background: #fafafa;
  border-radius: 14px;
  padding: 15px;
  border: 1px solid #ddd;
  font-size: 18px;
  text-align: left;
}
#todayRecords span {
  display: block;
  margin-bottom: 5px;
  padding-left: 5px;
  border-left: 3px solid #3498db;
}
</style>
</head>

<body>
<div class="card">
  <div id="userInfo">è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šä¸­...</div>
  <div id="statusInfo">æª¢æŸ¥ä¸­â€¦</div>
  <div id="dateTime">è¼‰å…¥ä¸­â€¦</div>
  <div class="buttons-container">
    <button id="btnStart">ä¸Šç­</button>
    <button id="btnEnd">ä¸‹ç­</button>
  </div>
  <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆé»æ“Šæ›´æ–°ï¼‰</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyeP9GTVDZLtw-FcwzFnajxbBUmjjVQbOdTFSmoFG6j8Lzodgwkae3n4-UoWKKeaVSo/exec"; // â† æ›¿æ›æˆä½ çš„ Apps Script Web App URL
let userId = "", userName = "";

// åˆå§‹åŒ–ä½¿ç”¨è€…
async function initUser() {
  try {
    await liff.init({ liffId: "2008786085-L1CtKqqv" });
    if (!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} æ‚¨å¥½`;
  } catch {
    document.getElementById("userInfo").textContent = "ä½¿ç”¨è€…è³‡è¨Šè¼‰å…¥å¤±æ•—";
  }
}

// æ™‚é–“æ›´æ–°
function updateDateTime() {
  const now = new Date();
  document.getElementById("dateTime").textContent =
    now.toLocaleString("zh-TW", { hour12: false });
}
setInterval(updateDateTime, 1000);
updateDateTime();

// å–å¾— IP
async function getIP() {
  const cache = sessionStorage.getItem("myIP");
  if (cache) return cache;
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP", data.ip);
    return data.ip;
  } catch { return ""; }
}

// æ›´æ–°æ‰“å¡ç‹€æ…‹
async function updateStatus() {
  const ip = await getIP();
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos => {
    const gps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    try {
      const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
      const data = await res.json();
      const statusEl = document.getElementById("statusInfo");
      if (data.rangeStatus === "æœ‰æ•ˆæ‰“å¡å€") {
        statusEl.style.background = "#2ecc71";
        statusEl.textContent = "æœ‰æ•ˆæ‰“å¡å€";
      } else {
        statusEl.style.background = "#e74c3c";
        const distText = data.distance!==null ? ` (${data.distance} å…¬å°º)` : "";
        statusEl.textContent = "ç„¡æ•ˆæ‰“å¡å€" + distText;
      }
    } catch {
      const statusEl = document.getElementById("statusInfo");
      statusEl.style.background = "#e74c3c";
      statusEl.textContent = "æª¢æŸ¥å¤±æ•—";
    }
  });
}
setInterval(updateStatus, 5000);
updateStatus();

// ä»Šæ—¥æ‰“å¡ç´€éŒ„
async function updateTodayRecords() {
  const today = new Date().toLocaleDateString("zh-TW",{timeZone:"Asia/Taipei"}).replace(/\//g,"-");
  const container = document.getElementById("todayRecords");
  container.innerHTML = "è¼‰å…¥ä¸­...";
  try {
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("æ ¼å¼éŒ¯èª¤");
    if (data.length === 0) {
      container.innerHTML = "ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡";
      return;
    }
    container.innerHTML = `ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆå…± ${data.length} æ¬¡ï¼‰ï¼š<br>`;
    data.forEach(r => {
      const color = r.rangeStatus === "æœ‰æ•ˆæ‰“å¡å€" ? "#2ecc71" : "#e74c3c";
      container.innerHTML += `<span style="border-left:3px solid ${color};">${r.status}ï¼š${r.time}ï¼ˆ${r.company}ï¼‰</span>`;
    });
  } catch {
    container.innerHTML = "ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—ï¼Œè«‹ç¨å€™é‡è©¦";
  }
}

// æ‰“å¡åŠŸèƒ½
async function clockInOut(status) {
  const btn = status==="ä¸Šç­" ? document.getElementById("btnStart") : document.getElementById("btnEnd");
  btn.disabled = true;
  const originalText = btn.textContent;

  let sec = 3;
  const timer = setInterval(()=>{ btn.textContent=`æ‰“å¡ä¸­â€¦ ${sec}s`; sec--; if(sec<0) clearInterval(timer); },1000);

  const ip = await getIP();

  if(!navigator.geolocation){
    clearInterval(timer); btn.textContent=originalText; btn.disabled=false;
    Swal.fire({icon:"error", title:"ğŸ˜¥ æ‰“å¡å¤±æ•—", html:"è«‹æŸ¥çœ‹ç´€éŒ„", timer:2000, showConfirmButton:false});
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps = { lat:pos.coords.latitude, lng:pos.coords.longitude };
    try {
      const res = await fetch(API_ENDPOINT,{
        method:"POST",
        body: JSON.stringify({ userId,userName,ip,gps,status })
      });
      const apiData = await res.json();

      if(apiData.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"){
        Swal.fire({ icon:"success", title:"ğŸ‰ æ‰“å¡æˆåŠŸï¼", html:`<strong>æ‰“å¡æ™‚é–“ï¼š</strong> ${apiData.date} ${apiData.time}`, timer:2000, showConfirmButton:false});
      } else {
        Swal.fire({ icon:"warning", title:"âš  æ‰“å¡ç„¡æ•ˆ", html:"<div style='font-size:16px;color:#3498db;font-weight:bold;margin-top:8px;'>â— ç•°åœ°æ‰“å¡è«‹å¿½ç•¥ â—</div>", timer:2000, showConfirmButton:false});
      }

      updateTodayRecords();
      updateStatus();
    } catch {
      Swal.fire({ icon:"error", title:"ğŸ˜¥ æ‰“å¡å¤±æ•—", html:"è«‹æŸ¥çœ‹ç´€éŒ„", timer:2000, showConfirmButton:false});
    } finally {
      clearInterval(timer); btn.textContent=originalText; btn.disabled=false;
    }
  }, ()=>{
    clearInterval(timer); btn.textContent=originalText; btn.disabled=false;
    Swal.fire({ icon:"error", title:"ğŸ˜¥ æ‰“å¡å¤±æ•—", html:"è«‹æŸ¥çœ‹ç´€éŒ„", timer:2000, showConfirmButton:false});
  });
}

document.getElementById("btnStart").onclick = ()=>clockInOut("ä¸Šç­");
document.getElementById("btnEnd").onclick = ()=>clockInOut("ä¸‹ç­");

window.onload = async ()=>{
  await initUser();
  updateTodayRecords();
};
</script>
</body>
</html>





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































