<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LINE 打卡</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body{margin:0;background:#f4f6f9;font-family:Arial;display:flex;justify-content:center}
.card{background:#fff;width:95%;max-width:420px;padding:25px;border-radius:20px;
box-shadow:0 8px 20px rgba(0,0,0,.15);text-align:center}
.clock{width:140px;height:140px;border-radius:50%;border:none;font-size:26px;
font-weight:bold;color:#fff;background:#3498db}
.statusBox{display:flex;gap:10px;margin:10px 0}
.status{flex:1;padding:10px;border-radius:10px;font-weight:bold}
.ok{background:#2ecc71;color:#fff}
.fail{background:#e74c3c;color:#fff}
</style>
</head>
<body>

<div class="card">
  <h2 id="user">載入中</h2>
  <div id="now"></div>

  <div class="statusBox">
    <div id="company" class="status">定位中</div>
    <div id="range" class="status">判斷中</div>
  </div>

  <button class="clock" onclick="clock()">打卡</button>
  <div id="today">今日打卡紀錄：</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbxr18Zud3teuJuWsF5gMalYoZNFJZv2GyE7P8tIY2T42r507xBVnqTF6Uo99zG8rWs4/exec";
let userId="",userName="";

liff.init({liffId:"你的 LIFF ID"}).then(async()=>{
  if(!liff.isLoggedIn()) liff.login();
  const p=await liff.getProfile();
  userId=p.userId; userName=p.displayName;
  user.textContent=`${userName} 您好`;
  loadToday();
});

setInterval(()=>now.textContent=new Date().toLocaleString("zh-TW",{hour12:false}),1000);

async function updateStatus(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const ip=(await fetch("https://api.ipify.org?format=json").then(r=>r.json())).ip;
    const res=await fetch(`${API}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const d=await res.json();
    company.textContent=d.nearestCompany?d.nearestCompany.name:"未知";
    range.textContent=d.rangeStatus;
    range.className="status "+(d.rangeStatus.includes("可")?"ok":"fail");
  });
}
setInterval(updateStatus,5000);
updateStatus();

async function clock(){
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps={lat:pos.coords.latitude,lng:pos.coords.longitude};
    const ip=(await fetch("https://api.ipify.org?format=json").then(r=>r.json())).ip;
    const res=await fetch(API,{method:"POST",body:JSON.stringify({userId,userName,ip,gps})});
    const d=await res.json();
    Swal.fire(d.message,"","success");
    loadToday();
  },()=>Swal.fire("無法取得 GPS","請開啟定位","error"));
}

function today(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

async function loadToday(){
  const res=await fetch(`${API}?action=getToday&userId=${userId}&date=${today()}`);
  const d=await res.json();
  todayDiv=document.getElementById("today");
  todayDiv.innerHTML="今日打卡紀錄：<br>"+(d.length?d.map(x=>`• ${x.status} ${x.time}（${x.company}）`).join("<br>"):"無");
}
</script>

</body>
</html>






































































































































































































































































