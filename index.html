<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>智能打卡系統</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:"Arial","Noto Sans TC";background:#f0f4f8;display:flex;justify-content:center;margin:0;padding:20px}
.card{background:#fff;width:95%;max-width:480px;border-radius:18px;padding:25px;box-shadow:0 15px 30px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:18px;align-items:center}
#userInfo{font-size:26px;font-weight:bold}
#statusInfo{font-size:20px;color:#fff;padding:8px 20px;border-radius:20px;min-width:200px;text-align:center}
#dateTime{font-size:18px;color:#666}
.buttons{display:flex;width:100%;gap:12px}
button{flex:1;padding:14px;font-size:22px;font-weight:bold;border:none;border-radius:12px;color:#fff;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
#btnStart{background:#3498db}
#btnEnd{background:#2ecc71}
#todayRecords{width:100%;border:1px solid #ddd;border-radius:12px;padding:12px;font-size:16px;background:#fafafa}
</style>
</head>

<body>
<div class="card">
  <div id="userInfo">載入中…</div>
  <div id="statusInfo">定位確認中…</div>
  <div id="dateTime"></div>

  <div class="buttons">
    <button id="btnStart" disabled>上班</button>
    <button id="btnEnd" disabled>下班</button>
  </div>

  <div id="todayRecords">今日打卡紀錄</div>
</div>

<script>
/* ================= 基本設定 ================= */
const API = "https://script.google.com/macros/s/AKfycbzOwXIv-6KNs6nBXF6Xk4eJ6picVCkMpdlydjcg-PSsNXDxs-czO5DpzDI5lj5UaWRE/exec";
const LIFF_ID = "2008786085-L1CtKqqv";

let userId="", userName="";
let lastGPS=null, gpsReady=false;
let statusChecked=false, canClock=false;

/* ================= DOM ================= */
const userInfo=document.getElementById("userInfo");
const statusInfo=document.getElementById("statusInfo");
const btnStart=document.getElementById("btnStart");
const btnEnd=document.getElementById("btnEnd");
const todayRecords=document.getElementById("todayRecords");
const dateTime=document.getElementById("dateTime");

/* ================= 時間 ================= */
setInterval(()=>{
  dateTime.textContent=new Date().toLocaleString("zh-TW",{hour12:false});
},1000);

/* ================= IP ================= */
async function getIP(){
  const c=sessionStorage.getItem("ip");
  if(c) return c;
  const r=await fetch("https://api.ipify.org?format=json");
  const j=await r.json();
  sessionStorage.setItem("ip",j.ip);
  return j.ip;
}

/* ================= GPS ================= */
function getCachedGPS(){
  return new Promise((resolve,reject)=>{
    if(lastGPS) return resolve(lastGPS);
    navigator.geolocation.getCurrentPosition(
      p=>{
        lastGPS={
          lat:p.coords.latitude,
          lng:p.coords.longitude,
          accuracy:p.coords.accuracy
        };
        gpsReady=true;
        resolve(lastGPS);
      },
      reject,
      {enableHighAccuracy:false,timeout:8000}
    );
  });
}

/* ================= 按鈕控制 ================= */
function updateButtons(){
  const enable=gpsReady && statusChecked && canClock;
  btnStart.disabled=!enable;
  btnEnd.disabled=!enable;
}

/* ================= LIFF ================= */
async function initUser(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) await liff.login();
  const p=await liff.getProfile();
  userId=p.userId;
  userName=p.displayName;
  userInfo.textContent=`${userName} 您好`;
}

/* ================= 狀態檢查（嚴格版） ================= */
async function updateStatus(){
  gpsReady=false;
  statusChecked=false;
  canClock=false;
  updateButtons();

  statusInfo.textContent="定位確認中…";
  statusInfo.style.background="#95a5a6";

  const ipP=getIP();
  const gpsP=getCachedGPS();

  gpsP.then(async gps=>{
    statusInfo.textContent="定位完成，檢查中…";
    statusInfo.style.background="#f1c40f";

    try{
      const ip=await ipP;
      const r=await fetch(
        `${API}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`
      );
      const d=await r.json();
      statusChecked=true;

      if(d.rangeStatus==="有效打卡區"){
        canClock=true;
        statusInfo.textContent="有效打卡區";
        statusInfo.style.background="#2ecc71";
      }else{
        canClock=false;
        statusInfo.textContent="無效打卡區";
        statusInfo.style.background="#e74c3c";
      }
    }catch{
      statusInfo.textContent="狀態錯誤";
      statusInfo.style.background="#e67e22";
    }
    updateButtons();
  });
}

/* ================= 打卡 ================= */
async function clock(status){
  if(!canClock){
    Swal.fire("尚未完成定位確認","","warning");
    return;
  }

  const gps=await getCachedGPS();
  const ip=await getIP();

  const r=await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      userId,userName,ip,gps,status
    })
  });
  const d=await r.json();

  Swal.fire(d.rangeStatus==="有效打卡區"?"成功":"異地",
    `${d.date} ${d.time}`,"info");

  updateStatus();
  loadToday();
}

btnStart.onclick=()=>clock("上班");
btnEnd.onclick=()=>clock("下班");

/* ================= 今日紀錄 ================= */
async function loadToday(){
  const d=new Date();
  const date=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
  const r=await fetch(`${API}?action=getToday&userId=${userId}&date=${date}`);
  const j=await r.json();
  todayRecords.innerHTML=j.length?j.map(x=>`${x.status}：${x.time}`).join("<br>"):"無紀錄";
}

/* ================= 啟動 ================= */
window.onload=async()=>{
  initUser();
  updateStatus();
  loadToday();
  setInterval(updateStatus,15000);
};
</script>
</body>
</html>


























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































