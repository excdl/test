<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {font-family:"Arial","Noto Sans TC",sans-serif;background:#f0f4f8;display:flex;justify-content:center;padding:20px;margin:0;}
.card {background:#fff;width:95%;max-width:480px;border-radius:20px;padding:25px 20px;display:flex;flex-direction:column;align-items:center;gap:20px;box-shadow:0 15px 30px rgba(0,0,0,0.15);}
#userInfo {font-size:28px;font-weight:bold;text-align:center;color:#2c3e50;}
#dateTime {font-size:22px;color:#7f8c8d;text-align:center;}
#statusInfo {font-size:20px;color:white;padding:8px 25px;border-radius:25px;text-align:center;min-width:180px;}
.buttons-container {display:flex;gap:15px;width:100%;}
.buttons-container button {flex:1;padding:15px 0;font-size:22px;font-weight:bold;border-radius:12px;border:none;cursor:pointer;color:white;transition:all 0.2s;}
#btnStart {background: linear-gradient(135deg, #3498db, #2980b9);}
#btnEnd {background: linear-gradient(135deg, #2ecc71, #27ae60);}
button:disabled {opacity:0.5;cursor:not-allowed;}
#todayRecords {width:100%;background:#fafafa;border-radius:14px;padding:15px;border:1px solid #ddd;font-size:18px;text-align:left;}
#todayRecords span {display:block;margin-bottom:5px;padding-left:5px;border-left:3px solid #3498db;}
</style>
</head>
<body>
<div class="card">
  <div id="userInfo">è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šä¸­...</div>
  <div id="statusInfo">å®šä½ç¢ºèªä¸­â€¦</div>
  <div id="dateTime">è¼‰å…¥ä¸­â€¦</div>
  <div class="buttons-container">
    <button id="btnStart" disabled>ä¸Šç­</button>
    <button id="btnEnd" disabled>ä¸‹ç­</button>
  </div>
  <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆé»æ“Šåˆ·æ–°ï¼‰</div>
</div>

<script>
const API_ENDPOINT="https://script.google.com/macros/s/AKfycbyvjio1hNQLv1IdPQztODkd3AjPuzO4-qjDbnbIW62TJGdb7IZTlpHPjRPRRRN-daiE/exec";
let userId="", userName="", dataReady=false;
let statusLoaded=false;

const btnStart=document.getElementById("btnStart");
const btnEnd=document.getElementById("btnEnd");
const userInfo=document.getElementById("userInfo");
const statusInfo=document.getElementById("statusInfo");
const dateTime=document.getElementById("dateTime");
const todayRecords=document.getElementById("todayRecords");

/* ===== æ—¥æœŸå­—ä¸² yyyy/MM/dd ===== */
function getTodayString(){
  const d=new Date();
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
}

/* ===== æŒ‰éˆ•é–å®š ===== */
function setButtonsLock(lock){
  btnStart.disabled=lock;
  btnEnd.disabled=lock;
}

/* ===== æ™‚é–“é¡¯ç¤º ===== */
function updateDateTime(){
  const now=new Date();
  dateTime.textContent=now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

/* ===== æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ ===== */
function formatDateTime(dateStr){
  if(!dateStr) return "";
  const d=new Date(dateStr);
  if(isNaN(d)) return dateStr;
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  return `${yyyy}/${mm}/${dd} ${hh}:${mi}:${ss}`;
}

/* ===== å–å¾— IP ===== */
let cachedIP=null;
async function getIP(){
  if(cachedIP) return cachedIP;
  try{
    const res=await fetch("https://api.ipify.org?format=json");
    const data=await res.json();
    cachedIP=data.ip;
    return cachedIP;
  }catch{return ""; }
}

/* ===== GPS å¿«å– ===== */
let lastGPS=null,lastGPSAt=0;
function getCachedGPS(maxAge=15000){
  return new Promise((resolve,reject)=>{
    const now=Date.now();
    if(lastGPS && now-lastGPSAt<maxAge){resolve(lastGPS);return;}
    navigator.geolocation.getCurrentPosition(
      pos=>{lastGPS={lat:pos.coords.latitude,lng:pos.coords.longitude};lastGPSAt=Date.now();resolve(lastGPS);},
      err=>reject(err),
      {enableHighAccuracy:false,timeout:5000}
    );
  });
}

/* ===== LIFF ä½¿ç”¨è€…åˆå§‹åŒ– ===== */
async function initUser(){
  await liff.init({liffId:"2008786085-L1CtKqqv"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile=await liff.getProfile();
  userId=profile.userId;
  userName=profile.displayName;
  userInfo.textContent=`${userName} æ‚¨å¥½`;
}

/* ===== æ›´æ–°æ‰“å¡å€ç‹€æ…‹ ===== */
async function updateStatus(){
  statusInfo.textContent = "å®šä½è¼‰å…¥ä¸­â€¦";
  statusInfo.style.background = "#95a5a6";
  try{
    const [ip, gps] = await Promise.all([getIP(), getCachedGPS()]);
    const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const data = await res.json();
    if(data.rangeStatus === "æœ‰æ•ˆæ‰“å¡å€"){
      statusInfo.style.background = "#2ecc71";
      statusInfo.textContent = "æœ‰æ•ˆæ‰“å¡å€";
    } else {
      statusInfo.style.background = "#e74c3c";
      const distText = data.distance!==null ? ` (${data.distance} å…¬å°º)` : "";
      statusInfo.textContent = "ç„¡æ•ˆæ‰“å¡å€"+distText;
    }
    statusLoaded = true;
  }catch(err){
    statusInfo.textContent = "å®šä½ç¢ºèªä¸­â€¦";
    statusInfo.style.background = "#95a5a6";
    console.warn("æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼š", err);
  }
}

/* ===== æ›´æ–°ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼Œåªé¡¯ç¤ºä¸Šç­/ä¸‹ç­æœ€æ–°å„1ç­† ===== */
async function updateTodayRecords(){
  todayRecords.innerHTML="è¼‰å…¥ä¸­...";
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${getTodayString()}`);
    const data = await res.json();
    if(!data.length){todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡"; return;}
    
    let lastStart = null;
    let lastEnd = null;
    data.forEach(r=>{
      if(r.status==="ä¸Šç­") lastStart = r;
      if(r.status==="ä¸‹ç­") lastEnd = r;
    });
    todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>";
    if(lastStart){
      let color="#3498db";
      todayRecords.innerHTML += `<span style="border-left-color:${color}">${lastStart.status}ï¼š${formatDateTime(lastStart.time)}ï¼ˆ${lastStart.company}ï¼‰</span>`;
    }
    if(lastEnd){
      let color="#2ecc71";
      if(lastEnd.company.includes("éŒ¯èª¤")) color="#e67e22";
      todayRecords.innerHTML += `<span style="border-left-color:${color}">${lastEnd.status}ï¼š${formatDateTime(lastEnd.time)}ï¼ˆ${lastEnd.company}ï¼‰</span>`;
    }
  }catch{
    todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—";
  }
}

/* ===== æ‰“å¡å¾Œç™¼é€ Flex Message ===== */
async function sendSelfMessage(record){
  if(!liff.isInClient()) return;
  let headerColor = "#3498db";
  if(record.status==="ä¸‹ç­") headerColor="#2ecc71";
  if(record.rangeStatus!=="æœ‰æ•ˆæ‰“å¡å€") headerColor="#e67e22";
  let reasonText = record.rangeStatus!=="æœ‰æ•ˆæ‰“å¡å€" ? "ç•°å¸¸åŸå› ï¼šè¶…å‡ºæ‰“å¡å€" : "";
  try{
    await liff.sendMessages([{
      type:'flex',
      altText:'æ‰“å¡é€šçŸ¥',
      contents:{
        type:"bubble",
        header:{
          type:"box",
          layout:"vertical",
          contents:[{type:"text", text:`${record.userName} å·²æ‰“å¡`, weight:"bold", size:"lg", color:"#ffffff"}],
          backgroundColor: headerColor,
          paddingAll:"12px"
        },
        body:{
          type:"box",
          layout:"vertical",
          spacing:"md",
          contents:[
            {type:"text", text:`ç‹€æ…‹ï¼š${record.status}`, size:"md"},
            {type:"text", text:`æ™‚é–“ï¼š${record.date} ${record.time}`, size:"md"},
            {type:"text", text:`ä½ç½®ï¼š${record.company}`, size:"md"},
            ...(reasonText?[{type:"text", text:reasonText, size:"md", color:"#e67e22"}]:[])
          ]
        }
      }
    }]);
  }catch(err){ console.error("è¨Šæ¯å‚³é€å¤±æ•—:", err);}
}

/* ===== æ‰“å¡åŠŸèƒ½ ===== */
async function clockInOut(status){
  if(!dataReady || !statusLoaded){
    Swal.fire({icon:"info",title:"è³‡æ–™è®€å–ä¸­æˆ–å®šä½ä¸­",timer:1500,showConfirmButton:false});
    return;
  }
  const btn = status==="ä¸Šç­"?btnStart:btnEnd;
  btn.disabled=true;
  const originalText = btn.textContent;

  // å€’æ•¸3ç§’æ•ˆæœ
  let sec = 3;
  const timer = setInterval(()=>{
    btn.textContent = `æ‰“å¡ä¸­â€¦ ${sec}s`;
    sec--;
    if(sec<0) clearInterval(timer);
  },1000);

  try{
    const [ip,gps] = await Promise.all([getIP(), getCachedGPS()]);
    const res = await fetch(API_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({userId,userName,ip,gps,status})
    });
    const data = await res.json();

    const record = {
      userName,
      status: data.status,
      date: data.date,
      time: data.time,
      company: data.company || "æœªçŸ¥",
      rangeStatus: data.rangeStatus
    };

    if(data.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"){
      Swal.fire({
        icon:"success",
        title:"ğŸ‰ æ‰“å¡æˆåŠŸï¼",
        html:`<strong>æ‰“å¡æ™‚é–“ï¼š</strong> ${formatDateTime(data.date+'T'+data.time)}`,
        showConfirmButton:false,
        timer:2000,
        backdrop:"rgba(0,0,0,0.5)"
      });
    }else{
      Swal.fire({
        icon:"warning",
        title:`<span style="font-size:20px;color:#e67e22;">âš  æ‰“å¡ç„¡æ•ˆ</span>`,
        html:`<div style="font-size:16px;color:#3498db;font-weight:bold;margin-top:8px;">â— ç•°åœ°æ‰“å¡è«‹å¿½ç•¥ â—</div>`,
        showConfirmButton:false,
        timer:2000,
        backdrop:"rgba(0,0,0,0.5)"
      });
    }

    sendSelfMessage(record);
    updateTodayRecords();
    updateStatus();

  }catch(err){
    console.error(err);
    Swal.fire({icon:"error",title:"ğŸ˜¥ æ‰“å¡å¤±æ•—",html:"è«‹æŸ¥çœ‹ç´€éŒ„",showConfirmButton:false,timer:2000,backdrop:"rgba(0,0,0,0.5)"});
  }finally{
    clearInterval(timer);
    btn.textContent=originalText;
    btn.disabled=false;
  }
}

btnStart.onclick = ()=> clockInOut("ä¸Šç­");
btnEnd.onclick = ()=> clockInOut("ä¸‹ç­");

/* ===== é é¢è¼‰å…¥ ===== */
window.onload = async()=>{
  setButtonsLock(true);
  await initUser();
  setButtonsLock(false);
  updateTodayRecords();
  updateStatus();
  dataReady=true;
  setInterval(updateStatus,15000);
};
</script>
</body>
</html>











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































