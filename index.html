<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‡ç´šç‰ˆæ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
<style>
body{margin:0;padding:0;font-family:Arial;background:#f0f4f8;}
#map{width:100vw;height:100vh;}
#clockBtn{
    position:absolute;bottom:30px;left:50%;transform:translateX(-50%);
    width:120px;height:120px;border-radius:50%;border:none;
    font-size:24px;color:#fff;font-weight:bold;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    transition:0.3s;z-index:5;
}
.clock-in{background:linear-gradient(145deg,#3498db,#2980b9);}
.clock-out{background:linear-gradient(145deg,#2ecc71,#27ae60);}
.error{background:linear-gradient(145deg,#e74c3c,#c0392b);}
#infoCard{
    position:absolute;top:20px;left:50%;transform:translateX(-50%);
    background:#fff;border-radius:18px;padding:15px 20px;
    box-shadow:0 8px 20px rgba(0,0,0,0.15);z-index:5;
    display:flex;flex-direction:column;align-items:center;gap:8px;
}
#userInfo{font-size:20px;font-weight:bold;}
#statusInfo{font-size:16px;padding:5px 12px;border-radius:20px;font-weight:bold;}
#todayRecords{font-size:14px;background:#fafafa;border-radius:12px;padding:10px;border:1px solid #ddd;cursor:pointer;}
</style>
</head>
<body>
<div id="map"></div>
<div id="clockBtn" class="clock-in">ä¸Šç­</div>
<div id="infoCard">
    <div id="userInfo">æ­£åœ¨ç²å–ä½¿ç”¨è€…è³‡è¨Š...</div>
    <div id="statusInfo"></div>
    <div id="todayRecords" onclick="updateTodayRecords()">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šé»æ“Šåˆ·æ–°</div>
</div>

<script>
const API_ENDPOINT="https://script.google.com/macros/s/AKfycbzveR74NPq6vbDZMdGg3PimAGRSYTW3exDf3drgNqn44oaxLPb-3sVTnDl-qkh_xyQ1/exec";
const COMPANY_IPS=["220.132.124.179","125.228.248.110","114.34.128.159"];
let userId="", userName="", map, userMarker, companyMarkers=[];

// ===== LIFF ç™»å…¥ =====
async function initLIFF(){
    await liff.init({ liffId:"YOUR_LIFF_ID" });
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId=profile.userId;
    userName=profile.displayName;
    document.getElementById("userInfo").textContent=userName+" æ‚¨å¥½";
}
initLIFF();

// ===== IPå–å¾— =====
async function getIP(){
    try{ const res=await fetch("https://api.ipify.org?format=json"); const data=await res.json(); return data.ip;} 
    catch{return "";}
}

// ===== åˆå§‹åŒ–åœ°åœ– =====
async function initMap(){
    map = new google.maps.Map(document.getElementById("map"), {zoom:15, center:{lat:25,lng:121}});
    const res = await fetch(`${API_ENDPOINT}?action=getCompanyLocations`);
    const locations = await res.json();
    companyMarkers=[];
    locations.forEach(loc=>{
        const marker = new google.maps.Marker({position:{lat:parseFloat(loc.lat), lng:parseFloat(loc.lng)}, map, title: loc.name});
        marker.allow=parseFloat(loc.allow);
        marker.name=loc.name;
        companyMarkers.push(marker);
    });
}
initMap();

// ===== ç²å–ä½¿ç”¨è€…ä½ç½® =====
async function getUserLocation(){
    return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}),
        err=>reject(err),{enableHighAccuracy:true});
    });
}

// ===== è¨ˆç®—è·é›¢ =====
function calcDistance(lat1,lng1,lat2,lng2){
    const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLng=(lng2-lng1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

// ===== æ›´æ–°ä»Šæ—¥æ‰“å¡ç´€éŒ„ =====
async function updateTodayRecords(){
    const container=document.getElementById("todayRecords");
    const today=new Date().toISOString().slice(0,10);
    try{
        const res=await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
        const data=await res.json();
        if(!data.length) container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡";
        else container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>"+data.map(r=>`${r.status} ${r.time} ${r.ip}`).join("<br>");
    } catch{ container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—";}
}

// ===== æ‰“å¡å‡½å¼ =====
async function performClock(){
    const btn=document.getElementById("clockBtn");
    btn.disabled=true;
    let ip = await getIP();
    let loc={lat:0,lng:0};
    try{ loc=await getUserLocation();} catch(e){ console.log(e);}
    // æ›´æ–°ä½¿ç”¨è€…åœ°åœ–ä½ç½®
    if(userMarker) userMarker.setMap(null);
    userMarker=new google.maps.Marker({position:loc,map,title:"æ‚¨ç›®å‰ä½ç½®",icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#0000FF",fillOpacity:1,strokeWeight:1}});
    map.setCenter(loc);

    // åˆ¤æ–·è·é›¢æœ€è¿‘å…¬å¸
    let nearest=null, minDist=Infinity;
    companyMarkers.forEach(c=>{
        const dist=calcDistance(loc.lat,loc.lng,c.getPosition().lat(),c.getPosition().lng());
        if(dist<minDist){ minDist=dist; nearest=c; }
        // æ”¹è®Šæ¨™è¨˜é¡è‰²
        c.setIcon({path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:(dist<=c.allow)?"#2ecc71":"#e74c3c",fillOpacity:1,strokeWeight:1});
    });
    const withinRange=nearest? minDist<=nearest.allow:false;
    const ipOk=COMPANY_IPS.includes(ip);

    // APIé€æ‰“å¡è³‡æ–™
    const status=btn.classList.contains("clock-in")?"ä¸Šç­":"ä¸‹ç­";
    await fetch(API_ENDPOINT,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,displayName:userName,status,lat:loc.lat,lng:loc.lng,ip})});

    // æç¤º
    if(withinRange && ipOk){
        btn.className="clock-out"; btn.textContent="ä¸‹ç­";
        Swal.fire({icon:"success",title:"ğŸ‰ æ‰“å¡æˆåŠŸ",html:`<b>å…¬å¸:</b> ${nearest.name}<br><b>è·é›¢:</b> ${Math.round(minDist)}m`,timer:2000,showConfirmButton:false});
    } else{
        btn.className="error"; Swal.fire({icon:"warning",title:"âš  éå…¬å¸ç¶²è·¯æˆ–ç•°åœ°",html:`<b>è·é›¢æœ€è¿‘å…¬å¸:</b> ${Math.round(minDist)}m<br><b>IP:</b> ${ip}`,timer:2500,showConfirmButton:false});
    }
    btn.disabled=false;
    updateTodayRecords();
}

// ===== äº‹ä»¶ç¶å®š =====
document.getElementById("clockBtn").onclick=performClock;
</script>
</body>
</html>






































































































































