<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f7f7f7; display:flex; justify-content:center; padding:25px; margin:0; }
.card { background:white; width:95%; max-width:480px; box-shadow:0 8px 25px rgba(0,0,0,0.12); border-radius:18px; padding:25px 20px; display:flex; flex-direction:column; align-items:center; gap:15px; }
#userInfo { font-size:26px; font-weight:bold; }
#dateTime { font-size:22px; }

/* 公司名稱與範圍平排顯示，自動縮排/滑動 */
#nearestInfo { font-size:18px; display:flex; gap:15px; justify-content:center; flex-wrap:nowrap; text-align:center; white-space:nowrap; overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none; }
#nearestInfo::-webkit-scrollbar { display:none; }

/* 圓形圓角按鈕 */
button.circleBtn { width:140px; height:140px; border-radius:50%; font-size:26px; font-weight:bold; border:none; cursor:pointer; transition:0.3s; }
button.circleBtn.on { background:linear-gradient(145deg,#3498db,#2980b9); color:white; }
button.circleBtn.off { background:linear-gradient(145deg,#2ecc71,#27ae60); color:white; }
button.circleBtn:hover { transform: translateY(-3px); box-shadow:0 8px 14px rgba(0,0,0,0.12); }

/* 今日打卡紀錄 */
#todayRecords { width:100%; background:#fafafa; border-radius:12px; padding:15px; border:1px solid #ddd; font-size:18px; cursor:pointer; word-break:break-word; }

/* 手機友好響應 */
@media(max-width:420px){
  #userInfo { font-size:22px; }
  #dateTime { font-size:18px; }
  #nearestInfo { font-size:16px; gap:10px; }
  button.circleBtn { width:120px; height:120px; font-size:22px; }
  #todayRecords { font-size:16px; }
}
</style>
</head>
<body>
<div class="card">
  <div id="userInfo">正在獲取使用者資訊...</div>
  <div id="dateTime">載入中…</div>
  
  <!-- 公司名稱 + 可打卡狀態平排 -->
  <div id="nearestInfo">
    <div id="companyName">載入中</div>
    <div id="rangeStatus">判斷中</div>
  </div>
  
  <!-- 圓形打卡按鈕 -->
  <button id="btnClock" class="circleBtn on">上班</button>

  <div id="todayRecords" onclick="updateTodayRecords()">今日打卡紀錄：點擊刷新</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycby5JV54chIcw1uurwybpAoA3Xt1eiSjuWyEZ1Aogtw2Tp_hq-NXEoXRQFNLeYcTOPp-/exec";
let userId="", userName="";
let isClockIn = true;

// 時間顯示
function updateDateTime(){
  const now = new Date();
  document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

// 取得使用者 LIFF 資訊
async function updateUserInfo(){
  await liff.init({liffId:"2008504718-nmXP0WRV"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile = await liff.getProfile();
  userId = profile.userId;
  userName = profile.displayName;
  document.getElementById("userInfo").textContent = `${userName} 您好`;
}

// 取得 IP
async function getIP(){
  const cache = sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    sessionStorage.setItem("myIP",data.ip);
    return data.ip;
  }catch{return "";}
}

// 公司名稱 & 打卡範圍即時檢查
async function checkCompanyStatus(){
  const ip = await getIP();
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const data = await res.json();
    document.getElementById("companyName").textContent = data.ipMatched ? data.nearestCompany.name : "不明連線";
    document.getElementById("rangeStatus").textContent = data.rangeStatus;
  });
}

// 打卡
async function performClock(){
  const ip = await getIP();
  if(!navigator.geolocation) { alert("無法取得 GPS"); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const gps = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    const status = isClockIn ? "上班" : "下班";
    const res = await fetch(API_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({userId,userName,ip,status,gps})
    });
    const data = await res.json();
    Swal.fire({icon:"success", title:data.message, timer:1500, showConfirmButton:false});
    isClockIn = !isClockIn;
    const btn = document.getElementById("btnClock");
    btn.textContent = isClockIn?"上班":"下班";
    btn.className = `circleBtn ${isClockIn?"on":"off"}`;
    updateTodayRecords();
    checkCompanyStatus();
  });
}

// 今日打卡紀錄
async function updateTodayRecords(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const dateStr = `${yyyy}-${mm}-${dd}`;
  try{
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${dateStr}`);
    const data = await res.json();
    const container = document.getElementById("todayRecords");
    if(!data.length){ container.innerHTML="今日打卡紀錄：無"; return; }
    container.innerHTML = "今日打卡紀錄：<br>" + data.map(r=>`${r.status} ${r.time} ${r.method} ${r.ip} ${r.nearestCompany} ${r.rangeStatus}`).join("<br>");
  }catch{
    document.getElementById("todayRecords").innerHTML="今日打卡紀錄：讀取失敗";
  }
}

document.getElementById("btnClock").onclick = performClock;

window.onload = async ()=>{
  await updateUserInfo();
  checkCompanyStatus();
  updateTodayRecords();
  setInterval(checkCompanyStatus,5000); // 每5秒更新
};
</script>
</body>
</html>








































































































































































































































































