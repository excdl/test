<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
<style>
body { margin:0; font-family: Arial; }
#map { width:100%; height:100vh; }
#clockBtn {
    position: absolute;
    bottom: 150px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: none;
    font-size: 26px;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    transition: 0.3s;
    display:flex; align-items:center; justify-content:center;
}
#clockBtn.on { background: linear-gradient(145deg, #2ecc71, #27ae60); }
#clockBtn.off { background: linear-gradient(145deg, #3498db, #2980b9); }
#clockBtn:active { transform: translateX(-50%) scale(0.95); }
#addressCard, #recordsCard {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    padding: 12px 20px;
    font-size: 16px;
    max-width: 90%;
}
#addressCard { top: 20px; }
#recordsCard { bottom: 20px; max-height:180px; overflow-y:auto; cursor:pointer; }
#countdownWrapper {
    position: absolute;
    bottom: 150px; left: 50%;
    transform: translateX(-50%);
    width: 140px; height:140px; pointer-events:none; display:none;
}
#circleProgress { fill:none; stroke-width:12; stroke-linecap:round; transform: rotate(-90deg); transform-origin: center;}
#countdownText { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; font-size:18px;}
</style>
</head>
<body>

<div id="map"></div>

<div id="countdownWrapper">
    <svg width="140" height="140">
        <circle id="circleProgress" cx="70" cy="70" r="60"></circle>
    </svg>
    <div id="countdownText">æ‰“å¡ä¸­...</div>
</div>

<button id="clockBtn" class="off">ä¸Šç­</button>
<div id="addressCard">è¼‰å…¥åœ°å€ä¸­...</div>
<div id="recordsCard">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šé»æ“Šåˆ·æ–°</div>

<script>
// ===== åŸºæœ¬è¨­å®š =====
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzveR74NPq6vbDZMdGg3PimAGRSYTW3exDf3drgNqn44oaxLPb-3sVTnDl-qkh_xyQ1/exec";
const COMPANY_SHEET = "å…¬å¸æ“šé»";

let map,userMarker,clockStatus="ä¸Šç­",userId="",userName="",userLat=0,userLng=0;

// ===== LIFF ç™»å…¥ =====
async function initLIFF(){
    await liff.init({ liffId: "YOUR_LIFF_ID" });
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId; userName = profile.displayName;
}

// ===== å–å¾— IP =====
async function getIP(){ try{ const res=await fetch("https://api.ipify.org?format=json"); return (await res.json()).ip; }catch{return "";}}

// ===== è¨ˆç®—è·é›¢ =====
function distance(lat1,lng1,lat2,lng2){
    const R=6371000; const toRad=Math.PI/180;
    const dLat=(lat2-lat1)*toRad; const dLng=(lng2-lng1)*toRad;
    const a=Math.sin(dLat/2)**2 + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLng/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

// ===== åˆå§‹åŒ–åœ°åœ– =====
function initMap(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            userLat=pos.coords.latitude; userLng=pos.coords.longitude;
            map=new google.maps.Map(document.getElementById("map"),{center:{lat:userLat,lng:userLng},zoom:16});
            userMarker=new google.maps.Marker({position:{lat:userLat,lng:userLng}, map, title:"æ‚¨ç›®å‰ä½ç½®", icon:{url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}});
            const geocoder=new google.maps.Geocoder();
            geocoder.geocode({location:{lat:userLat,lng:userLng}}, (results,status)=>{
                if(status==="OK"&&results[0]) document.getElementById("addressCard").textContent = results[0].formatted_address;
            });
            loadCompanyMarkers();
        });
    }else alert("ç„¡æ³•å–å¾—ä½ç½®");
}

// ===== è¼‰å…¥å…¬å¸æ“šé» =====
async function loadCompanyMarkers(){
    try{
        const res = await fetch(`${API_ENDPOINT}?action=getCompany&sheet=${COMPANY_SHEET}`);
        const data = await res.json();
        const infoWindow = new google.maps.InfoWindow();
        data.forEach(c=>{
            const dist=distance(userLat,userLng,parseFloat(c.lat),parseFloat(c.lng));
            const isOut = dist>parseFloat(c.allow);
            const color = isOut?"red":"green";
            const marker = new google.maps.Marker({position:{lat:parseFloat(c.lat),lng:parseFloat(c.lng)}, map, icon:{url:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`}});
            marker.addListener("click", ()=>{
                infoWindow.setContent(`<div style="font-size:14px;line-height:1.4;">
                    <strong>${c.name}</strong><br>è·é›¢:${Math.round(dist)} m<br>å…è¨±ç¯„åœ:${c.allow} m<br>
                    <span style="color:${isOut?'red':'green'};">${isOut?'è¶…å‡ºç¯„åœ':'å¯æ‰“å¡'}</span>
                </div>`);
                infoWindow.open(map, marker);
            });
        });
    }catch(err){ console.error(err); }
}

// ===== æ‰“å¡å‹•ç•« + API =====
async function performClockIn(status,lat,lng){
    const ip = await getIP();
    const wrapper = document.getElementById("countdownWrapper");
    const circle = document.getElementById("circleProgress");
    const text = document.getElementById("countdownText");
    wrapper.style.display="block"; text.textContent="æ‰“å¡ä¸­...";
    const radius=60, circumference=2*Math.PI*radius;
    circle.style.strokeDasharray=circumference;
    circle.style.strokeDashoffset=circumference;
    let progress=0;

    function animate(){
        progress=Math.min(progress+0.01,1);
        circle.style.strokeDashoffset=circumference*(1-progress);
        if(progress<1) requestAnimationFrame(animate);
        else setTimeout(()=>{ wrapper.style.display="none"; },600);
    }
    requestAnimationFrame(animate);

    try{
        const res = await fetch(API_ENDPOINT,{method:"POST",body:JSON.stringify({userId,userName,status,lat,lng,ip})});
        const data = await res.json();
        if(data.message.includes("æˆåŠŸ")) Swal.fire({icon:"success",title:"ğŸ‰ æ‰“å¡æˆåŠŸ",html:`<strong>æ‰“å¡æ™‚é–“ï¼š</strong>${data.date} ${data.time}`,timer:2000,showConfirmButton:false,backdrop:"rgba(0,0,0,0.5)"});
        else Swal.fire({icon:"error",title:"ğŸ˜¥ æ‰“å¡å¤±æ•—",html:data.message,timer:2000,showConfirmButton:false,backdrop:"rgba(0,0,0,0.5)"});
        updateTodayRecords();
    }catch(err){ console.error(err); }
}

// ===== ä»Šæ—¥æ‰“å¡ç´€éŒ„ =====
async function updateTodayRecords(){
    try{
        const today = new Date().toLocaleDateString("zh-TW").replace(/\//g,"/");
        const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
        const data = await res.json();
        const container=document.getElementById("recordsCard");
        if(!data.length) container.textContent="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡";
        else container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>"+data.map(r=>{
            const time=r.time;
            const makeup=r.isMakeup?"(è£œæ‰“å¡-å¾…å¯©æ ¸)":"";
            return `${r.status} ${time} ${makeup}`;
        }).join("<br>");
    }catch(err){ console.error(err); }
}
document.getElementById("recordsCard").addEventListener("click",updateTodayRecords);

// ===== æŒ‰éˆ•äº‹ä»¶ =====
const clockBtn = document.getElementById("clockBtn");
clockBtn.addEventListener("click", async ()=>{
    if(!userLat||!userLng)return;
    await performClockIn(clockStatus,userLat,userLng);
    if(clockStatus==="ä¸Šç­"){ clockStatus="ä¸‹ç­"; clockBtn.textContent="ä¸‹ç­"; clockBtn.classList.replace("off","on"); }
    else{ clockStatus="ä¸Šç­"; clockBtn.textContent="ä¸Šç­"; clockBtn.classList.replace("on","off"); }
});

// ===== åˆå§‹åŒ– =====
window.onload = async ()=>{
    await initLIFF();
    initMap();
    updateTodayRecords();
};
</script>
</body>
</html>






































































































































